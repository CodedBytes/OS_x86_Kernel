#include "graph.h"
#include <stdint.h>

// ===========================
// Font 8x8 simples ASCII
// ===========================
static const uint8_t font8x8_basic[128][8] = {
    [0]  = {0,0,0,0,0,0,0,0},    [1]  = {0,0,0,0,0,0,0,0},    [2]  = {0,0,0,0,0,0,0,0},    [3]  = {0,0,0,0,0,0,0,0},
    [4]  = {0,0,0,0,0,0,0,0},    [5]  = {0,0,0,0,0,0,0,0},    [6]  = {0,0,0,0,0,0,0,0},    [7]  = {0,0,0,0,0,0,0,0},
    [8]  = {0,0,0,0,0,0,0,0},    [9]  = {0,0,0,0,0,0,0,0},    [10] = {0,0,0,0,0,0,0,0},    [11] = {0,0,0,0,0,0,0,0},
    [12] = {0,0,0,0,0,0,0,0},    [13] = {0,0,0,0,0,0,0,0},    [14] = {0,0,0,0,0,0,0,0},    [15] = {0,0,0,0,0,0,0,0},
    [16] = {0,0,0,0,0,0,0,0},    [17] = {0,0,0,0,0,0,0,0},    [18] = {0,0,0,0,0,0,0,0},    [19] = {0,0,0,0,0,0,0,0},
    [20] = {0,0,0,0,0,0,0,0},    [21] = {0,0,0,0,0,0,0,0},    [22] = {0,0,0,0,0,0,0,0},    [23] = {0,0,0,0,0,0,0,0},
    [24] = {0,0,0,0,0,0,0,0},    [25] = {0,0,0,0,0,0,0,0},    [26] = {0,0,0,0,0,0,0,0},    [27] = {0,0,0,0,0,0,0,0},
    [28] = {0,0,0,0,0,0,0,0},    [29] = {0,0,0,0,0,0,0,0},    [30] = {0,0,0,0,0,0,0,0},    [31] = {0,0,0,0,0,0,0,0},

    [32] = {0,0,0,0,0,0,0,0},     // ' '
    [33] = {0x18,0x18,0x18,0x18,0x18,0,0x18,0}, // !
    [34] = {0x36,0x36,0x12,0,0,0,0,0},          // "
    [35] = {0x36,0x36,0x7F,0x36,0x7F,0x36,0x36,0}, // #
    [36] = {0x0C,0x3E,0x03,0x1E,0x30,0x1F,0x0C,0}, // $
    [37] = {0x00,0x63,0x33,0x18,0x0C,0x66,0x63,0}, // %
    [38] = {0x1C,0x36,0x1C,0x6E,0x3B,0x33,0x6E,0}, // &
    [39] = {0x06,0x06,0x03,0,0,0,0,0},          // '
    [40] = {0x0C,0x06,0x03,0x03,0x03,0x06,0x0C,0}, // (
    [41] = {0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0}, // )
    [42] = {0,0x66,0x3C,0xFF,0x3C,0x66,0,0},     // *
    [43] = {0,0x18,0x18,0x7E,0x18,0x18,0,0},     // +
    [44] = {0,0,0,0,0,0x18,0x18,0x30},           // ,
    [45] = {0,0,0,0x7E,0,0,0,0},                 // -
    [46] = {0,0,0,0,0,0x18,0x18,0},             // .
    [47] = {0,0x01,0x03,0x06,0x0C,0x18,0x30,0}, // /

    [48] = {0x3C,0x66,0x6E,0x76,0x66,0x66,0x3C,0}, // 0
    [49] = {0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0}, // 1
    [50] = {0x3C,0x66,0x06,0x0C,0x18,0x30,0x7E,0}, // 2
    [51] = {0x3C,0x66,0x06,0x1C,0x06,0x66,0x3C,0}, // 3
    [52] = {0x0C,0x1C,0x3C,0x6C,0x7E,0x0C,0x0C,0}, // 4
    [53] = {0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0}, // 5
    [54] = {0x1C,0x30,0x60,0x7C,0x66,0x66,0x3C,0}, // 6
    [55] = {0x7E,0x66,0x0C,0x18,0x30,0x30,0x30,0}, // 7
    [56] = {0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0}, // 8
    [57] = {0x3C,0x66,0x66,0x3E,0x06,0x0C,0x38,0}, // 9

    [58] = {0,0x18,0,0,0,0x18,0,0},       // :
    [59] = {0,0x18,0,0,0,0x18,0x18,0x30}, // ;
    [60] = {0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0}, // <
    [61] = {0,0,0x7E,0,0,0,0,0},           // =
    [62] = {0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0}, // >
    [63] = {0x3C,0x66,0x06,0x0C,0x18,0,0x18,0}, // ?
    [64] = {0x3C,0x66,0x6E,0x6A,0x6E,0x60,0x3E,0}, // @

    [65] = {0x18,0x3C,0x66,0x66,0x7E,0x66,0x66,0}, // A
    [66] = {0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0}, // B
    [67] = {0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0}, // C
    [68] = {0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0}, // D
    [69] = {0x7E,0x60,0x60,0x7C,0x60,0x60,0x7E,0}, // E
    [70] = {0x7E,0x60,0x60,0x7C,0x60,0x60,0x60,0}, // F
    [71] = {0x3C,0x66,0x60,0x6E,0x66,0x66,0x3C,0}, // G
    [72] = {0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0}, // H
    [73] = {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0}, // I
    [74] = {0x1E,0x0C,0x0C,0x0C,0x0C,0x6C,0x38,0}, // J
    [75] = {0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0}, // K
    [76] = {0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0}, // L
    [77] = {0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0}, // M
    [78] = {0x66,0x76,0x7E,0x6E,0x66,0x66,0x66,0}, // N
    [79] = {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0}, // O
    [80] = {0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0}, // P
    [81] = {0x3C,0x66,0x66,0x66,0x6A,0x36,0x1C,0}, // Q
    [82] = {0x7C,0x66,0x66,0x7C,0x78,0x6C,0x66,0}, // R
    [83] = {0x3C,0x66,0x60,0x3C,0x06,0x66,0x3C,0}, // S
    [84] = {0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0}, // T
    [85] = {0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0}, // U
    [86] = {0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0}, // V
    [87] = {0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0}, // W
    [88] = {0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0}, // X
    [89] = {0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0}, // Y
    [90] = {0x7E,0x06,0x0C,0x18,0x30,0x60,0x7E,0}, // Z
    [91] = {0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0}, // [
    [92] = {0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0}, // \
    [93] = {0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0}, // ]
    [94] = {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0}, // ^
    [95] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF}, // _
    [96] = {0x18,0x0C,0x06,0,0,0,0,0},                // `
    [97] = {0,0,0x3C,0x06,0x3E,0x66,0x3E,0},         // a
    [98] = {0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0},   // b
    [99] = {0,0,0x3C,0x66,0x60,0x66,0x3C,0},         // c
    [100]= {0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0},   // d
    [101]= {0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0},   // e
    [102]= {0x0C,0x18,0x3C,0x18,0x3E,0x18,0x18,0},   // f
    [103]= {0x00,0x00,0x3C,0x66,0x66,0x3E,0x06,0},   // g
    [104]= {0x60,0x60,0x66,0x66,0x7E,0x66,0x66,0},   // h
    [105]= {0x18,0x00,0x18,0x18,0x18,0x18,0x18,0},   // i
    [106]= {0x0C,0x00,0x0C,0x0C,0x0C,0x0C,0x6C,0x38}, // j
    [107]= {0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0},   // k
    [108]= {0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0},   // l
    [109]= {0,0,0x36,0x7F,0x7F,0x63,0x63,0},          // m
    [110]= {0,0,0x36,0x7E,0x66,0x66,0x66,0},          // n
    [111]= {0,0,0x3C,0x66,0x66,0x66,0x3C,0},          // o
    [112]= {0,0,0x7C,0x66,0x66,0x7C,0x60,0x60},       // p
    [113]= {0,0,0x3E,0x66,0x66,0x3E,0x06,0x3C},       // q
    [114]= {0,0,0x36,0x6E,0x66,0x60,0x60,0},          // r
    [115]= {0,0,0x3C,0x60,0x3C,0x06,0x3C,0},          // s
    [116]= {0x18,0x18,0x7E,0x18,0x18,0x18,0x0C,0},    // t
    [117]= {0,0,0x66,0x66,0x66,0x66,0x3E,0},          // u
    [118]= {0,0,0x66,0x66,0x66,0x3C,0x18,0},          // v
    [119]= {0,0,0x63,0x6B,0x7F,0x77,0x63,0},          // w
    [120]= {0,0,0x66,0x3C,0x18,0x3C,0x66,0},          // x
    [121]= {0,0,0x66,0x66,0x66,0x3E,0x06,0x3C},       // y
    [122]= {0,0,0x7E,0x06,0x0C,0x18,0x7E,0},          // z
    [123]= {0x0E,0x18,0x18,0x70,0x18,0x18,0x0E,0},    // {
    [124]= {0x18,0x18,0x18,0x18,0x18,0x18,0x18,0},    // |
    [125]= {0x70,0x18,0x18,0x0E,0x18,0x18,0x70,0},    // }
    [126]= {0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0},    // ~
    [127]= {0,0,0,0,0,0,0,0}                           // DEL
};

// ===========================
// VESA framebuffer
// ===========================
void vesa_init(uint32_t fb, uint32_t w, uint32_t h, uint32_t bpp, uint32_t pitch) {
    vesa_info.framebuffer = fb;
    vesa_info.width       = w;
    vesa_info.height      = h;
    vesa_info.bpp         = bpp;
    vesa_info.pitch       = pitch;
}

void vesa_clear(uint32_t color) {
    if (!vesa_info.framebuffer) return;
    uint8_t* fb = (uint8_t*)vesa_info.framebuffer;
    uint32_t bytes_per_pixel = vesa_info.bpp / 8;
    for (uint32_t y = 0; y < vesa_info.height; y++)
        for (uint32_t x = 0; x < vesa_info.width; x++)
            *(uint32_t*)(fb + y * vesa_info.pitch + x * bytes_per_pixel) = color;
}

void vesa_put_pixel(int x, int y, uint32_t color) {
    if (!vesa_info.framebuffer) return;
    if (x < 0 || x >= (int)vesa_info.width || y < 0 || y >= (int)vesa_info.height) return;
    uint32_t bytes_per_pixel = vesa_info.bpp / 8;
    uint8_t* fb = (uint8_t*)vesa_info.framebuffer;
    *(uint32_t*)(fb + y * vesa_info.pitch + x * bytes_per_pixel) = color;
}

void vesa_draw_rect(int x, int y, int w, int h, uint32_t color) {
    for (int j = 0; j < h; j++)
        for (int i = 0; i < w; i++)
            vesa_put_pixel(x + i, y + j, color);
}

// ===========================
// Desenha um caractere ASCII 8x8
// ===========================
void vesa_draw_char(int x, int y, char c, uint32_t color) {
    if (c < 0 || c > 127) return;
    const uint8_t* bitmap = font8x8_basic[(uint8_t)c];
    for (int row = 0; row < 8; row++) {
        uint8_t bits = bitmap[row];
        for (int col = 0; col < 8; col++) {
            if (bits & (1 << (7 - col)))
                vesa_put_pixel(x + col, y + row, color);
        }
    }
}

// ===========================
// Desenha uma string
// ===========================
void vesa_draw_string(int x, int y, const char* str, uint32_t color) {
    int orig_x = x;
    while (*str) {
        if (*str == '\n') {
            y += 8;
            x = orig_x;
        } else {
            vesa_draw_char(x, y, *str, color);
            x += 8;
        }
        str++;
    }
}

